!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["kaitify-core"]={})}(this,(function(e){"use strict";var t=Object.defineProperty,n=(e,n,s)=>(((e,n,s)=>{n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s})(e,"symbol"!=typeof n?n+"":n,s),s);const s={formatNumber(e){return this.isNumber(e)?e.toString().replace(/(\d)(?=(?:\d{3})+$)/g,"$1,"):e},isNumber:e=>"number"==typeof e&&!isNaN(e),add:(...e)=>e.reduce(((e,t)=>{let n=0,s=0,i=0;try{n=e.toString().split(".")[1].length}catch(o){}try{s=t.toString().split(".")[1].length}catch(o){}return i=Math.pow(10,Math.max(n,s)),(e*i+t*i)/i})),subtract:(...e)=>e.reduce(((e,t)=>{let n=0,s=0,i=0;try{n=e.toString().split(".")[1].length}catch(o){}try{s=t.toString().split(".")[1].length}catch(o){}return i=Math.pow(10,Math.max(n,s)),(e*i-t*i)/i})),mutiply:(...e)=>e.reduce(((e,t)=>{let n=0,s=e.toString(),i=t.toString();try{n+=s.split(".")[1].length}catch(o){}try{n+=i.split(".")[1].length}catch(o){}return Number(s.replace(".",""))*Number(i.replace(".",""))/Math.pow(10,n)})),divide:(...e)=>e.reduce(((e,t)=>{let n=0,s=0,i=e.toString(),o=t.toString();try{n=i.split(".")[1].length}catch(r){}try{s=o.split(".")[1].length}catch(r){}return Number(i.replace(".",""))/Number(o.replace(".",""))*Math.pow(10,s-n)}))},i={insert(e,t,n){if(!e||"string"!=typeof e)throw new TypeError("The first argument must be a string");if("string"!=typeof t)throw new TypeError("The second argument must be a string");if(!s.isNumber(n))throw new TypeError("The third argument must be a number");if(n<0)throw new Error("The third argument cannot be less than 0");return e.substring(0,n)+t+e.substring(n,e.length)},delete(e,t,n){if(!e||"string"!=typeof e)throw new TypeError("The first argument must be a string");if(!s.isNumber(t))throw new TypeError("The second argument must be a number");if(t<0)throw new Error("The second argument cannot be less than 0");if(!s.isNumber(n))throw new TypeError("The third argument must be a number");if(n<0)throw new Error("The third argument cannot be less than 0");return e.substring(0,t)+e.substring(t+n,e.length)},replace(e,t,n,i){if(!e||"string"!=typeof e)throw new TypeError("The first argument must be a string");if(!s.isNumber(t))throw new TypeError("The second argument must be a number");if(t<0)throw new Error("The second argument cannot be less than 0");if(!s.isNumber(n))throw new TypeError("The third argument must be a number");if(n<0)throw new Error("The third argument cannot be less than 0");if("string"!=typeof i)throw new TypeError("The fourth argument must be a string");return e.substring(0,t)+i+e.substring(n,e.length)},trim(e,t){if("string"!=typeof e)throw new TypeError("The first argument must be a string");let n=e.replace(/(^\s+)|(\s+$)/g,"");return t&&(n=n.replace(/\s/g,"")),n}},o={isWindow:e=>e&&e instanceof Window,getElementPoint(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(this.isElement(t)||(t=document.body),!this.isContains(t,e))throw new Error("The second argument and the first argument have no hierarchical relationship");let n=e,s=0,i=0;for(;this.isElement(e)&&this.isContains(t,e)&&t!==e;)s+=e.offsetTop,i+=e.offsetLeft,e=e.offsetParent;return{top:s,left:i,right:t.offsetWidth-i-n.offsetWidth,bottom:t.offsetHeight-s-n.offsetHeight}},isContains(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(!this.isElement(t))throw new TypeError("The second argument must be an element");return e===t||(e.contains?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t)))},isParentNode(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(!this.isElement(t))throw new TypeError("The second argument must be an element");return e!==t&&t.parentNode===e},children(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(t&&"string"!=typeof t)throw new TypeError("The second argument must be a string");return[...e.querySelectorAll(t||"*")].filter((t=>t.parentNode===e))},siblings(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(t&&"string"!=typeof t)throw new TypeError("The second argument must be a string");if(!e.parentNode)return[];return[...e.parentNode.querySelectorAll(t||"*")].filter((t=>t.parentNode===e.parentNode&&t!=e))},rem2px(e){if(!s.isNumber(e))throw new TypeError("The argument must be a number");let t=this.getCssStyle(document.documentElement,"font-size");return s.mutiply(e,parseFloat(t))},px2rem(e){if(!s.isNumber(e))throw new TypeError("The argument must be a number");let t=this.getCssStyle(document.documentElement,"font-size");return s.divide(e,parseFloat(t))},width(e){"string"==typeof e&&e&&(e=document.body.querySelector(e)),this.isElement(e)||(e=document.body);let t=e.clientWidth,n=parseFloat(this.getCssStyle(e,"padding-left")),i=parseFloat(this.getCssStyle(e,"padding-right"));return s.subtract(t,n,i)},height(e){"string"==typeof e&&e&&(e=document.body.querySelector(e)),this.isElement(e)||(e=document.body);let t=e.clientHeight,n=parseFloat(this.getCssStyle(e,"padding-top")),i=parseFloat(this.getCssStyle(e,"padding-bottom"));return s.subtract(t,n,i)},removeClass(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");let n=e.classList;i.trim(t).split(/\s+/).forEach((e=>{n.remove(e)}))},addClass(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");let n=e.classList;i.trim(t).split(/\s+/).forEach((e=>{n.add(e)}))},hasClass(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");let n=e.classList;return i.trim(t).split(/\s+/).every((e=>n.contains(e)))},scrollTopBottomTrigger(e,t){"string"==typeof e&&e&&(e=document.body.querySelector(e));let n=window;this.isElement(e)&&e!=document.body&&e!=document.documentElement&&(n=e),"function"==typeof e&&(t=e);let i=!0;n.addEventListener("scroll",(()=>{if(this.getScrollTop(n)<=0){if(!i)return;"function"==typeof t&&(i=!1,t({state:"top",target:n}))}else{let e={state:"bottom",target:n},o=0;if(o=n==window?window.innerHeight:n.clientHeight,s.add(this.getScrollTop(n),o)+1>=this.getScrollHeight(n)&&o!=this.getScrollHeight(n)){if(!i)return;"function"==typeof t&&(i=!1,t(e))}else i=!0}}))},getScrollWidth(e){"string"==typeof e&&e&&(e=document.body.querySelector(e));let t=0;return t=this.isElement(e)&&e!=document.documentElement&&e!=document.body?e.scrollWidth:0==document.documentElement.scrollWidth||0==document.body.scrollWidth?document.documentElement.scrollWidth||document.body.scrollWidth:document.documentElement.scrollWidth>document.body.scrollWidth?document.documentElement.scrollWidth:document.body.scrollWidth,t},getScrollHeight(e){"string"==typeof e&&e&&(e=document.body.querySelector(e));let t=0;return t=this.isElement(e)&&e!=document.documentElement&&e!=document.body?e.scrollHeight:0==document.documentElement.scrollHeight||0==document.body.scrollHeight?document.documentElement.scrollHeight||document.body.scrollHeight:document.documentElement.scrollHeight>document.body.scrollHeight?document.documentElement.scrollHeight:document.body.scrollHeight,t},setScrollTop(e){let t=!1,n=e.el;"string"==typeof n&&n&&(n=document.body.querySelector(n));let i=e.number||0,o=e.time||0;return this.isElement(n)&&n!=document.body&&n!=document.documentElement&&n!=window||(t=!0),new Promise((e=>{if(o<=0)t?document.documentElement.scrollTop=document.body.scrollTop=i:n.scrollTop=i,e();else{let r=10,l=s.divide(o,r),a=this.getScrollTop(n),d=s.divide(s.subtract(i,a),l),c=setInterval((()=>{l>0?(l--,t?document.documentElement.scrollTop=document.body.scrollTop=a=s.add(a,d):n.scrollTop=a=s.add(a,d)):(clearInterval(c),e())}),r)}}))},getScrollTop(e){"string"==typeof e&&e&&(e=document.body.querySelector(e));let t=0;return t=this.isElement(e)&&e!=document.body&&e!=document.documentElement&&e!=window?e.scrollTop:0==document.documentElement.scrollTop||0==document.body.scrollTop?document.documentElement.scrollTop||document.body.scrollTop:document.documentElement.scrollTop>document.body.scrollTop?document.documentElement.scrollTop:document.body.scrollTop,t},getScrollLeft(e){"string"==typeof e&&e&&(e=document.body.querySelector(e));let t=0;return t=this.isElement(e)&&e!=document.body&&e!=document.documentElement&&e!=window?e.scrollLeft:0==document.documentElement.scrollLeft||0==document.body.scrollLeft?document.documentElement.scrollLeft||document.body.scrollLeft:document.documentElement.scrollLeft>document.body.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft,t},setScrollLeft(e){let t=!1,n=e.el;"string"==typeof n&&n&&(n=document.body.querySelector(n));let i=e.number||0,o=e.time||0;return this.isElement(n)&&n!=document.body&&n!=document.documentElement&&n!=window||(t=!0),new Promise((e=>{if(o<=0)t?document.documentElement.scrollLeft=document.body.scrollLeft=i:n.scrollLeft=i,e();else{let r=10,l=s.divide(o,r),a=this.getScrollLeft(n),d=s.divide(s.subtract(i,a),l),c=setInterval((()=>{l>0?(l--,t?document.documentElement.scrollLeft=document.body.scrollLeft=a=s.add(a,d):n.scrollLeft=a=s.add(a,d)):(clearInterval(c),e())}),r)}}))},getCssStyle(e,t){if(!this.isElement(e))throw new TypeError("The first argument must be an element");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");let n="";return n=document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e)[t]:e.currentStyle[t],n},getCssSelector(e){if(!e||"string"!=typeof e)throw new TypeError("The argument must be a selector string");if(/^#{1}/.test(e))return{type:"id",value:e.substr(1)};if(/^\./.test(e))return{type:"class",value:e.substr(1)};if(/^\[(.+)\]$/.test(e)){let t="attribute",n="",s=i.trim(e,!0).substring(1,i.trim(e,!0).length-1).split("=");return 1==s.length&&(n=s[0]),2==s.length&&(n={attributeName:s[0],attributeValue:s[1].replace(/\'/g,"").replace(/\"/g,"")}),{type:t,value:n}}return{type:"tag",value:e}},getElementBounding(e){"string"==typeof e&&e&&(e=document.body.querySelector(e)),this.isElement(e)||(e=document.body);let t=e.getBoundingClientRect();return{top:t.top,bottom:s.subtract(document.documentElement.clientHeight||window.innerHeight,t.bottom),left:t.left,right:s.subtract(document.documentElement.clientWidth||window.innerWidth,t.right)}},isElement:e=>e&&e instanceof Node&&1===e.nodeType,string2dom(e){if(!e||"string"!=typeof e)throw new TypeError("The argument must be an HTML string");const t=document.createElement("template");return t.innerHTML=e,1==t.content.children.length?t.content.children[0]:Array.from(t.content.children)}},r="_dap-datas",l={remove(e,t){if(!(e instanceof Document||o.isElement(e)||o.isWindow(e)))throw new TypeError("The first argument must be an element node or window or document");let n=e[r]||{};null==t||""===t?e[r]={}:(delete n[t],e[r]=n)},has(e,t){if(!(e instanceof Document||o.isElement(e)||o.isWindow(e)))throw new TypeError("The first argument must be an element node or window or document");if(null==t||""===t)throw new TypeError("The second parameter must be a unique key");return(e[r]||{}).hasOwnProperty(t)},get(e,t){if(!(e instanceof Document||o.isElement(e)||o.isWindow(e)))throw new TypeError("The first argument must be an element node or window or document");let n=e[r]||{};return null==t||""===t?n:n[t]},set(e,t,n){if(!(e instanceof Document||o.isElement(e)||o.isWindow(e)))throw new TypeError("The first argument must be an element node or window or document");if(null==t||""===t)throw new TypeError("The second parameter must be a unique key");let s=e[r]||{};s[t]=n,e[r]=s}},a={matchingText(e,t){if(!e||"string"!=typeof e)throw new TypeError("The first argument must be a string");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");let n=null;if("Chinese"==t&&(n=/^[\u4e00-\u9fa5]+$/),"chinese"==t&&(n=/[\u4e00-\u9fa5]/),"email"==t&&(n=/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/),"username"==t&&(n=/^[a-zA-Z0-9_]{4,16}$/),"int+"==t&&(n=/^\d+$/),"int-"==t&&(n=/^-\d+$/),"int"==t&&(n=/^-?\d+$/),"pos"==t&&(n=/^\d*\.?\d+$/),"neg"==t&&(n=/^-\d*\.?\d+$/),"number"==t&&(n=/^-?\d*\.?\d+$/),"phone"==t&&(n=/^1[0-9]\d{9}$/),"idCard"==t&&(n=/^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/),"url"==t&&(n=/^(https?|ftp):\/\/(-\.)?([^\s\/?\.#-]+\.?)+(\/[^\s]*)?$/),"IPv4"==t&&(n=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/),"hex"==t&&(n=/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/),"rgb"==t&&(n=/^rgb\((25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d),\s?(25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d),\s?(25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)\)$/),"rgba"==t&&(n=/^rgba\((25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d),\s?(25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d),\s?(25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d),\s?(0?\.\d|1(\.0)?|0)\)$/),"QQ"==t&&(n=/^[1-9][0-9]{4,10}$/),"weixin"==t&&(n=/^[a-zA-Z]([-_a-zA-Z0-9]{5,19})+$/),"plate"==t&&(n=/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}[A-Z0-9]{4}[A-Z0-9挂学警港澳]{1}$/),!n)throw new Error("The second parameter is out of scope");return n.test(e)},getUrlParams(e){if(!e||"string"!=typeof e)throw new TypeError("The argument must be a string");let t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),n=window.location.search.substr(1);if(!n){let e=window.location.hash.split("?");2==e.length&&(n=e[1])}let s=n.match(t);return s?decodeURIComponent(s[2]):null},isEmptyObject(e){return!!this.isObject(e)&&0==Object.keys(e).length},equal(e,t){if(typeof e!=typeof t)return!1;if(this.isObject(e)&&this.isObject(t)){let n=Object.getOwnPropertyNames(e),s=Object.getOwnPropertyNames(t);if(n.length!=s.length)return!1;let i=n.length,o=!0;for(let r=0;r<i;r++){let s=n[r],i=e[s],l=t[s];if(!this.equal(i,l)){o=!1;break}}return o}return e===t},isObject:e=>!("object"!=typeof e||!e),copyText(e){if(!e||"string"!=typeof e)throw new TypeError("No text to copy is defined");if(!navigator.clipboard)throw new Error("navigator.clipboard must be obtained in a secure environment, such as localhost, 127.0.0.1, or https, so the method won't work");return navigator.clipboard.writeText(e)},clone(e){if(this.isObject(e)){if(Array.isArray(e))return e.map((e=>this.clone(e)));let t={};for(let n in e)t[n]=this.clone(e[n]);return t}return e}},d=e=>{let t=e.split(/[\s]+/g),n=[];return t.forEach((e=>{let t=e.split("."),s={eventName:t[0]};t.length>1&&(s.guid=t[1]),n.push(s)})),n},c=(e,t,n)=>{let s=l.get(e,"dap-defined-events")||{},i=Object.keys(s),o=i.length;for(let r=0;r<o;r++){let o=i[r];s[o].type==t&&(n?o==t+"."+n&&(e.removeEventListener(s[o].type,s[o].fn,s[o].options),s[o]=void 0):(e.removeEventListener(s[o].type,s[o].fn,s[o].options),s[o]=void 0))}s=(e=>{let t={};return Object.keys(e).forEach((n=>{e[n]&&(t[n]=e[n])})),t})(s),l.set(e,"dap-defined-events",s)},h={on(e,t,n,s){if(!(e instanceof Document||o.isElement(e)||o.isWindow(e)))throw new TypeError("The first argument must be an element node or window or document");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");if(!n||"function"!=typeof n)throw new TypeError("The third argument must be a function");a.isObject(s)||(s={});d(t).forEach((t=>{((e,t,n,s,i)=>{let o=l.get(e,"dap-defined-events")||{};n||(n=l.get(e,"dap-event-guid")||0,l.set(e,"dap-event-guid",n+1)),o[n=t+"."+n]&&o[n].type==t&&e.removeEventListener(t,o[n].fn,o[n].options),e.addEventListener(t,s,i),o[n]={type:t,fn:s,options:i},l.set(e,"dap-defined-events",o)})(e,t.eventName,t.guid,n.bind(e),s)}))},off(e,t){if(!(e instanceof Document||o.isElement(e)||o.isWindow(e)))throw new TypeError("The first argument must be an element node or window or document");let n=l.get(e,"dap-defined-events");if(!n)return;if(!t){let t=Object.keys(n),s=t.length;for(let i=0;i<s;i++){let s=t[i];e.removeEventListener(n[s].type,n[s].fn,n[s].options)}return l.remove(e,"dap-defined-events"),void l.remove(e,"dap-event-guid")}d(t).forEach((t=>{c(e,t.eventName,t.guid)}))},get(e){if(!(e instanceof Document||o.isElement(e)||o.isWindow(e)))throw new TypeError("The first argument must be an element node or window or document");let t=l.get(e,"dap-defined-events");if(t)return t}},u={getImageUrl(e){if(!(e&&e instanceof File))throw new TypeError("The argument must be a File object");return window.URL.createObjectURL(e)},dataFileToBase64:e=>new Promise(((t,n)=>{e&&e instanceof File||n(new TypeError("The argument must be a File object"));let s=new FileReader;s.readAsDataURL(e),s.onloadend=()=>{let e=s.result;t(e)}})),dataBase64toFile(e,t){if(!e||"string"!=typeof e)throw new TypeError("The first argument must be a string");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");let n=e.split(","),s=n[0].match(/:(.*?);/)[1],i=atob(n[1]),o=i.length,r=new Uint8Array(o);for(;o--;)r[o]=i.charCodeAt(o);return new File([r],t,{type:s})},compressImage(e,t){const n={width:void 0,quality:.8,mimeType:"jpeg",maxSize:0,minSize:0};a.isObject(t)&&(s.isNumber(t.width)&&(n.width=t.width),s.isNumber(t.quality)&&t.quality>=0&&t.quality<=1&&(n.quality=t.quality),"jpeg"!=t.mimeType&&"webp"!=t.mimeType||(n.mimeType=t.mimeType),s.isNumber(t.maxSize)&&(n.maxSize=t.maxSize),s.isNumber(t.minSize)&&(n.minSize=t.minSize));const i=(e,t,s)=>{let o=e.toDataURL("image/"+n.mimeType,s),r=this.dataBase64toFile(o,t);if(n.maxSize>0&&r.size>1024*n.maxSize){s=s<=0?0:Number((s-.01).toFixed(2));const n=i(e,t,s);o=n.url,r=n.file,s=n.quality}return{file:r,url:o,quality:s}};return new Promise(((t,s)=>{let o=new FileReader;o.readAsDataURL(e),o.onload=()=>{let r=o.result,l=new Image;l.src=r,l.onload=()=>{if(n.minSize>0&&e.size<=1024*n.minSize)return void t({file:e,url:r,quality:1,width:l.width,height:l.height});let s=document.createElement("canvas"),o=s.getContext("2d");s.width=n.width||l.width,s.height=n.width?n.width/(l.width/l.height):l.height,o.drawImage(l,0,0,s.width,s.height);let a=e.name.lastIndexOf(".");const d=e.name.substring(0,a)+"."+n.mimeType;let c=i(s,d,n.quality);t({...c,width:s.width,height:s.height})},l.onerror=()=>{s(new Error("Failed to load image file"))}},o.onerror=()=>{s(new Error("Failed to load image file"))}}))}},f={language:()=>window.navigator.browserLanguage||window.navigator.language,device(){const e=window.navigator.userAgent;return{PC:!e.match(/AppleWebKit.*Mobile.*/),Mobile:!!e.match(/AppleWebKit.*Mobile.*/),iPhone:e.includes("iPhone"),Phone:e.includes("Android")&&/(?:Mobile)/.test(e)||e.includes("iPhone")||/(?:Windows Phone)/.test(e),iPad:e.includes("iPad"),Tablet:e.includes("iPad")||e.includes("Android")&&!/(?:Mobile)/.test(e)||e.includes("Firefox")&&/(?:Tablet)/.test(e),WindowsPhone:/(?:Windows Phone)/.test(e)}},browser(){const e=window.navigator.userAgent;return{Edge:!!e.match(/Edg\/([\d.]+)/),weixin:e.includes("MicroMessenger"),QQ:e.includes("QQ"),QQBrowser:e.includes("MQQBrowser"),UC:e.includes("UCBrowser"),Chrome:e.includes("Chrome"),Firefox:e.includes("Firefox"),sougou:e.toLocaleLowerCase().includes("se 2.x")||e.toLocaleLowerCase().includes("metasr")||e.toLocaleLowerCase().includes("sogou"),Safari:e.includes("Safari")&&!e.includes("Chrome")}},browserKernel(){const e=window.navigator.userAgent;return e.includes("Presto")?"opera":e.includes("AppleWebKit")?"webkit":e.includes("Gecko")&&!e.includes("KHTML")?"gecko":""},os(){const e=window.navigator.userAgent;return{Windows:e.includes("Windows"),Windows_CPU:e.toLocaleLowerCase().includes("win64")||e.toLocaleLowerCase().includes("wow64")?"x64":e.toLocaleLowerCase().includes("win32")||e.toLocaleLowerCase().includes("wow32")?"x32":"",Windows_Version:e.includes("Windows NT 6.1")||e.includes("Windows 7")?"Win7":e.includes("Windows NT 6.3")||e.includes("Windows NT 6.2")||e.includes("Windows NT 8")?"Win8":e.includes("Windows NT 10")||e.includes("Windows NT 6.4")?"Win10":"",Mac:e.includes("Macintosh"),Mac_Version:function(){if(e.includes("Macintosh")){const t=e.match(/Mac OS X ([^\s]+)\)/);if(t&&t[1])return t[1].split(/_|\./).join(".")}return""}(),ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),ios_Version:function(){if(e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){const t=e.match(/CPU.+OS ([^\s]+) like Mac OS X/);if(t&&t[1])return t[1].split(/_|\./).join(".")}return""}(),Android:e.includes("Android"),Android_Version:function(){const t=e.match(/Android ([^\s]+);/);return t&&t[1]?t[1].split(/_|\./).join("."):""}(),Linux:e.includes("Linux"),HarmonyOS:e.includes("HarmonyOS"),Ubuntu:e.includes("Ubuntu")}}},p="data-kaitify-node",m=(e,t)=>t.isText()?{tag:e.textRenderTag,namespace:t.namespace,attrs:t.hasMarks()?a.clone({...t.marks,[p]:t.key}):{[p]:t.key},styles:t.hasStyles()?a.clone(t.styles):{},textContent:t.textContent}:{tag:t.tag,namespace:t.namespace,attrs:t.hasMarks()?a.clone({...t.marks,[p]:t.key}):{[p]:t.key},styles:t.hasStyles()?a.clone(t.styles):{},children:t.hasChildren()?t.children.map((t=>m(e,t))):[]},g=e=>/^[\uFEFF]+$/g.test(e),y=(e,t)=>3==t.nodeType?o.isContains(e,t.parentNode):o.isContains(e,t),w=(e=0)=>new Promise((t=>{setTimeout((()=>{t()}),e)}));class b{constructor(){n(this,"key",(()=>{let e=l.get(window,"data-kaitify-knode-key")||0;return e++,l.set(window,"data-kaitify-knode-key",e),e})()),n(this,"type"),n(this,"tag"),n(this,"textContent"),n(this,"marks"),n(this,"styles"),n(this,"locked",!1),n(this,"fixed",!1),n(this,"namespace"),n(this,"children"),n(this,"parent"),n(this,"clone",((e=!0)=>{const t=b.create({type:this.type,tag:this.tag,marks:a.clone(this.marks),styles:a.clone(this.styles),namespace:this.namespace,textContent:this.textContent,locked:this.locked,fixed:this.fixed});return e&&this.hasChildren()&&this.children.forEach((n=>{const s=n.clone(e);t.hasChildren()?t.children.push(s):t.children=[s],s.parent=t})),t})),n(this,"firstTextClosedInNode",(e=>{if(!this.isText()&&!this.isClosed())return!1;if(this.isEqual(e))return!1;if(e.isContains(this)){const t=b.flat(e.children).filter((e=>e.isText()||e.isClosed()));return this.isEqual(t[0])}return!1}))}isBlock(){return"block"==this.type}isInline(){return"inline"==this.type}isClosed(){return"closed"==this.type}isText(){return"text"==this.type}getBlock(){return this.isBlock()?this:this.parent.getBlock()}getInline(){return this.isInline()?this:this.parent?this.parent.getInline():null}hasChildren(){return!this.isText()&&!this.isClosed()&&(Array.isArray(this.children)&&!!this.children.length)}isEmpty(){return this.isText()?!this.textContent:!(!this.isInline()&&!this.isBlock())&&(!this.hasChildren()||this.children.every((e=>e.isEmpty())))}isZeroWidthText(){return this.isText()&&!this.isEmpty()&&g(this.textContent)}isPlaceholder(){return this.isClosed()&&"br"==this.tag}hasMarks(){return!!this.marks&&(!!a.isObject(this.marks)&&!a.isEmptyObject(this.marks))}hasStyles(){return!!this.styles&&(!!a.isObject(this.styles)&&!a.isEmptyObject(this.styles))}isUneditable(){return this.hasMarks()&&"false"==this.marks.contenteditable?this:this.parent?this.parent.isUneditable():null}allIsPlaceholder(){if(this.hasChildren()){const e=this.children.filter((e=>!e.isEmpty()));return e.length&&e.every((e=>e.isPlaceholder()))}return!1}toEmpty(){if(!this.isEmpty()){if(!this.isText())return this.isClosed()?(this.type="text",void(this.textContent=void 0)):void(this.hasChildren()&&this.children.forEach((e=>{e.toEmpty()})));this.textContent=void 0}}isEqualStyles(e){return!this.hasStyles()&&!e.hasStyles()||!!(this.hasStyles()&&e.hasStyles()&&a.equal(this.styles,e.styles))}isEqualMarks(e){return!this.hasMarks()&&!e.hasMarks()||!!(this.hasMarks()&&e.hasMarks()&&a.equal(this.marks,e.marks))}isInCodeBlockStyle(){const e=this.getBlock();if("pre"==e.tag)return!0;const t=e.hasStyles()&&e.styles.whiteSpace||"";return!!["pre","pre-wrap"].includes(t)||!!e.parent&&e.parent.isInCodeBlockStyle()}isEqual(e){return!!b.isKNode(e)&&this.key==e.key}isContains(e){return!!this.isEqual(e)||!this.isClosed()&&!this.isText()&&(!!e.parent&&this.isContains(e.parent))}fullClone(){const e=b.create({type:this.type,tag:this.tag,marks:a.clone(this.marks),styles:a.clone(this.styles),namespace:this.namespace,textContent:this.textContent,locked:this.locked,fixed:this.fixed});return e.key=this.key,this.hasChildren()&&this.children.forEach((t=>{const n=t.fullClone();e.hasChildren()?e.children.push(n):e.children=[n],n.parent=e})),e}lastTextClosedInNode(e){if(!this.isText()&&!this.isClosed())return!1;if(this.isEqual(e))return!1;if(e.isContains(this)){const t=b.flat(e.children).filter((e=>e.isText()||e.isClosed()));return this.isEqual(t[t.length-1])}return!1}getPrevious(e){const t=e.findIndex((e=>e.isEqual(this)));if(t<=0)return null;const n=e[t-1];return n.isEmpty()?t-1==0?null:n.getPrevious(e):n}getNext(e){const t=e.findIndex((e=>e.isEqual(this)));if(t<0||t==e.length-1)return null;const n=e[t+1];return n.isEmpty()?t+1==e.length-1?null:n.getNext(e):n}static create(e){var t;const n=new b;return n.type=e.type,n.tag=e.tag,n.textContent=e.textContent,n.fixed=e.fixed||!1,n.locked=e.locked||!1,n.marks=a.clone(e.marks),n.styles=a.clone(e.styles),n.namespace=e.namespace,n.children=null==(t=e.children)?void 0:t.map((e=>{const t=b.create(e);return t.parent=n,t})),n}static createZeroWidthText(e){return b.create({type:"text",textContent:"\ufeff",marks:null==e?void 0:e.marks,styles:null==e?void 0:e.styles,namespace:null==e?void 0:e.namespace,locked:null==e?void 0:e.locked})}static createPlaceholder(){return b.create({type:"closed",tag:"br"})}static isKNode(e){return e instanceof b}static flat(e){const t=[],n=e.length;for(let s=0;s<n;s++)if(t.push(e[s]),e[s].hasChildren()){const n=b.flat(e[s].children);t.push(...n)}return t}static searchByKey(e,t){let n=null;const s=t.length;for(let i=0;i<s;i++){const s=t[i];if(s&&s.key==Number(e)){n=s;break}if(s&&s.hasChildren()){const t=b.searchByKey(e,s.children);if(t){n=t;break}}}return n}}const N=[{tag:"p"},{tag:"div"},{tag:"table"},{tag:"ul"},{tag:"ol"},{tag:"h1"},{tag:"h2"},{tag:"h3"},{tag:"h4"},{tag:"h5"},{tag:"h6"},{tag:"blockquote"},{tag:"pre"},{tag:"address",parse:!0},{tag:"article",parse:!0},{tag:"aside",parse:!0},{tag:"nav",parse:!0},{tag:"section",parse:!0},{tag:"li"},{tag:"tfoot",fixed:!0},{tag:"tbody",fixed:!0},{tag:"thead",fixed:!0},{tag:"tr",fixed:!0},{tag:"th",fixed:!0},{tag:"td",fixed:!0},{tag:"colgroup",fixed:!0}],C=[{tag:"span"},{tag:"a"},{tag:"label"},{tag:"code"},{tag:"b",parse:{fontWeight:"bold"}},{tag:"strong",parse:{fontWeight:"bold"}},{tag:"sup",parse:{verticalAlign:"super"}},{tag:"sub",parse:{verticalAlign:"sub"}},{tag:"i",parse:{fontStyle:"italic"}},{tag:"u",parse:{textDecorationLine:"underline"}},{tag:"del",parse:{textDecorationLine:"line-through"}},{tag:"abbr",parse:!0},{tag:"acronym",parse:!0},{tag:"bdo",parse:!0},{tag:"font",parse:{fontFamily:e=>e.getAttribute("face")||""}}],T=[{tag:"br"},{tag:"col"},{tag:"img"},{tag:"hr"},{tag:"video"},{tag:"audio"}];class x{constructor(){n(this,"start"),n(this,"end")}focused(){return!!this.start&&!!this.end}collapsed(){return!!this.focused()&&(this.start.node.isEqual(this.end.node)&&this.start.offset==this.end.offset)}}class E{constructor(){n(this,"records",[]),n(this,"redoRecords",[])}cloneSelection(e,t){const n=new x;if(t.focused()){const s=b.searchByKey(t.start.node.key,e),i=b.searchByKey(t.end.node.key,e);s&&i&&(n.start={node:s,offset:t.start.offset},n.end={node:i,offset:t.end.offset})}return n}setState(e,t){const n=e.map((e=>e.fullClone())),s=this.cloneSelection(n,t);this.records.push({nodes:n,selection:s}),this.redoRecords=[]}setUndo(){if(this.records.length>1){const e=this.records.pop();this.redoRecords.push(e);const t=this.records[this.records.length-1],n=t.nodes.map((e=>e.fullClone()));return{nodes:n,selection:this.cloneSelection(n,t.selection)}}return null}setRedo(){if(this.redoRecords.length>0){const e=this.redoRecords.pop();this.records.push(e);const t=e.nodes.map((e=>e.fullClone()));return{nodes:t,selection:this.cloneSelection(t,e.selection)}}return null}updateSelection(e){const t=this.records[this.records.length-1],n=this.cloneSelection(t.nodes,e);this.records[this.records.length-1].selection=n}}const k=({node:e})=>{if(e.hasChildren()&&!e.isEmpty()){const t=e.children.filter((e=>!e.isEmpty())),n=t.filter((e=>e.isBlock()));n.length&&(e.isInline()||n.length!=t.length)&&n.forEach((e=>{e.type="inline"}))}},S=({editor:e,node:t})=>{if(t.hasChildren()){const n=t.children.filter((e=>!e.isEmpty())),s=n.filter((e=>e.isPlaceholder()));t.isInline()&&s.length?s.forEach((e=>{e.toEmpty()})):n.length>1&&s.length==n.length?(e.selection.focused()&&(t.isContains(e.selection.start.node)&&e.setSelectionBefore(s[0],"start"),t.isContains(e.selection.end.node)&&e.setSelectionBefore(s[0],"end")),t.children=[s[0]]):n.length>1&&s.length&&s.forEach((e=>{e.toEmpty()}))}},v=({editor:e,node:t})=>{if((t.isBlock()||t.isInline())&&t.hasChildren()&&t.children.length>1){let n=0;for(;t.hasChildren()&&n<=t.children.length-2;){e.getAllowMergeNode(t.children[n],"nextSibling")?(e.applyMergeNode(t.children[n],"nextSibling"),t.hasChildren()&&1==t.children.length&&e.applyMergeNode(t.children[0],"parent")):n++}}},P=({editor:e,node:t})=>{(t.isBlock()||t.isInline())&&t.hasChildren()&&1==t.children.length&&e.getAllowMergeNode(t.children[0],"parent")&&(e.applyMergeNode(t.children[0],"parent"),e.getAllowMergeNode(t,"prevSibling")?e.applyMergeNode(t,"prevSibling"):e.getAllowMergeNode(t,"nextSibling")&&e.applyMergeNode(t,"nextSibling"))},I=({editor:e,node:t})=>{if(t.isText()&&!t.isEmpty()&&t.textContent.split("").some((e=>g(e)))){let n=t.textContent,s=0;for(;s<n.length;){const o=n.charAt(s);s>0&&g(o)&&g(n.charAt(s-1))?(e.isSelectionInNode(t,"start")&&e.selection.start.offset>=s+1&&(e.selection.start.offset-=1),e.isSelectionInNode(t,"end")&&e.selection.end.offset>=s+1&&(e.selection.end.offset-=1),n=i.delete(n,s,1)):s++}t.textContent=n}},B=(e,t)=>{let n=[];if(e.length&&t.length){let s=0,i=0,o=e.length-1,r=t.length-1;for(;s<=o&&i<=r;){if(t[i])if(t[r])if(e[s].key==t[i].key)n.push(...A(e[s],t[i])),s++,i++;else if(e[o].key==t[r].key)n.push(...A(e[o],t[r])),o--,r--;else if(e[s].key==t[r].key)n.push({type:"move",newNode:e[s],oldNode:t[r]},...A(e[s],t[r])),s++,r--;else if(e[o].key==t[i].key)n.push({type:"move",newNode:e[o],oldNode:t[i]},...A(e[o],t[i])),o--,i++;else{let i=t.findIndex((t=>t&&t.key===e[s].key));i>=0?(n.push({type:"move",newNode:e[s],oldNode:t[i]},...A(e[s],t[i])),t[i]=null):n.push({type:"insert",newNode:e[s],oldNode:null}),s++}else r--;else i++;if(i>r)for(;s<=o;s++)n.push({type:"insert",newNode:e[s],oldNode:null});else if(s>o)for(;i<=r;i++)t[i]&&n.push({type:"remove",oldNode:t[i],newNode:null})}}else e.length?n=e.map((e=>({type:"insert",newNode:e,oldNode:null}))):t.length&&(n=t.map((e=>({type:"remove",oldNode:e,newNode:null}))));return n},A=(e,t)=>{const n=[];return e.isEmpty()||t.isEmpty()?n.push({type:"empty",oldNode:t,newNode:e}):e.type!=t.type||e.locked!=t.locked||e.fixed!=t.fixed?n.push({type:"replace",newNode:e,oldNode:t}):e.isText()||e.tag==t.tag?e.hasChildren()&&!t.hasChildren()||t.hasChildren()&&!e.hasChildren()?n.push({type:"replace",newNode:e,oldNode:t}):(e.isText()&&e.textContent!=t.textContent&&n.push({type:"update",oldNode:t,newNode:e,update:"textContent"}),e.isEqualMarks(t)||n.push({type:"update",newNode:e,oldNode:t,update:"marks"}),e.isEqualStyles(t)||n.push({type:"update",newNode:e,oldNode:t,update:"styles"}),e.hasChildren()&&t.hasChildren()&&n.push(...B(e.children,t.children))):n.push({type:"replace",newNode:e,oldNode:t}),n},M=async(e,t)=>{const n=t.getData("text/html"),s=t.getData("text/plain"),i=t.files;if(n&&e.allowPasteHtml){const t=e.htmlParseNode(n).filter((e=>!e.isEmpty()));if("function"!=typeof e.onPasteHtml||await e.onPasteHtml.apply(e,[t,n])){e.insertNode(t[0]);for(let n=t.length-1;n>=1;n--)e.addNodeAfter(t[n],t[0]);e.setSelectionAfter(t[t.length-1],"all")}}else if(s){("function"!=typeof e.onPasteText||await e.onPasteText.apply(e,[s]))&&e.insertText(s)}else if(i.length){const t=i.length;for(let n=0;n<t;n++)if(i[n].type.startsWith("image/")){if("function"!=typeof e.onPasteImage||await e.onPasteImage.apply(e,[i[n]])){const t=await u.dataFileToBase64(i[n]),s=b.create({type:"closed",tag:"img",marks:{src:t,alt:i[n].name||""}});e.insertNode(s)}}else if(i[n].type.startsWith("video/")){if("function"!=typeof e.onPasteVideo||await e.onPasteVideo.apply(e,[i[n]])){const t=await u.dataFileToBase64(i[n]),s=b.create({type:"closed",tag:"video",marks:{src:t,alt:i[n].name||""}});e.insertNode(s)}}else"function"==typeof e.onPasteFile&&e.onPasteFile.apply(e,[i[n]])}},R=function(){if(!this.$el)return;if(this.isComposition)return;if(this.internalCauseSelectionChange)return;this.updateSelection()&&(this.history.updateSelection(this.selection),"function"==typeof this.onSelectionUpdate&&this.onSelectionUpdate.apply(this,[this.selection]))},L=async function(e){const t=e;"insertCompositionText"!==t.inputType&&"insertFromComposition"!==t.inputType&&(t.preventDefault(),this.isEditable()&&this.selection.focused()&&("insertText"==t.inputType&&t.data?(this.insertText(t.data),this.updateView()):"deleteContentBackward"==t.inputType||"deleteByCut"==t.inputType||"deleteByDrag"==t.inputType?(this.delete(),this.updateView()):"insertParagraph"==t.inputType||"insertLineBreak"==t.inputType?(this.insertParagraph(),this.updateView()):"insertFromPaste"==t.inputType?t.dataTransfer&&this.allowPaste&&(await M(this,t.dataTransfer),this.updateView()):"insertFromDrop"==t.inputType&&(await w(),t.dataTransfer&&this.allowPaste&&(await M(this,t.dataTransfer),this.updateView()))))},q=async function(e){const t=e;if(this.isEditable())if("compositionstart"==t.type)this.isComposition=!0;else if("compositionend"==t.type){const e=window.getSelection().getRangeAt(0).endContainer,t=e.parentNode,n=this.findNode(t);if(n.isText()&&n.textContent!=e.textContent){const t=n.textContent||"";n.textContent=e.textContent||"",this.isSelectionInNode(n)&&this.updateSelection(),e.textContent=t,await this.updateView()}else if(!n.isText()){const s=Array.from(t.childNodes).findIndex((t=>t.isEqualNode(e))),i=this.domParseNode(e);n.children.splice(s,0,i),i.parent=n,t.removeChild(e),this.selection.focused()&&this.setSelectionAfter(i,"all"),await this.updateView()}this.isComposition=!1}},$=function(e){if(this.isComposition)return;const t=e;if("keydown"==t.type){if(!this.isEditable())return;!function(e){const{Mac:t}=f.os();return t?"z"==e.key.toLocaleLowerCase()&&e.metaKey&&!e.shiftKey&&!e.altKey&&!e.ctrlKey:"z"==e.key.toLocaleLowerCase()&&e.ctrlKey&&!e.shiftKey&&!e.altKey&&!e.metaKey}(t)?function(e){const{Mac:t}=f.os();return t?"z"==e.key.toLocaleLowerCase()&&e.metaKey&&e.shiftKey&&!e.altKey&&!e.ctrlKey:"y"==e.key.toLocaleLowerCase()&&e.ctrlKey&&!e.shiftKey&&!e.altKey&&!e.metaKey}(t)&&(t.preventDefault(),this.redo()):(t.preventDefault(),this.undo()),"function"==typeof this.onKeydown&&this.onKeydown.apply(this,[t])}else if("keyup"==t.type){if(!this.isEditable())return;"function"==typeof this.onKeyup&&this.onKeyup.apply(this,[t])}},O=function(e){this.isEditable()&&"function"==typeof this.onFocus&&this.onFocus.apply(this,[e])},F=function(e){this.isEditable()&&"function"==typeof this.onBlur&&this.onBlur.apply(this,[e])},W=async function(e){const t=e;this.allowCopy||t.preventDefault()},D=(e,t)=>{let n=!0;if(3==t.nodeType)if(t.parentNode&&1==t.parentNode.childNodes.length)try{e.findNode(t.parentNode).isText()||(n=!1)}catch(s){n=!1}else n=!1;else if(1==t.nodeType)try{e.findNode(t)}catch(s){n=!1}return n},K=e=>{e.domObserver&&(e.domObserver.disconnect(),e.domObserver=null)},H=e=>{window.MutationObserver||console.warn("The current browser does not support MutationObserver"),K(e),e.domObserver=new MutationObserver((t=>{if(e.isComposition)return;let n=!1;const s=[];for(let i=0;i<t.length;i++){const o=t[i];if("characterData"==o.type){const t=o.target.parentNode,i=e.findNode(t);if(i.isText()&&i.textContent!=o.target.textContent){const t=i.textContent||"";i.textContent=o.target.textContent||"",e.isSelectionInNode(i)&&e.updateSelection(),K(e),o.target.textContent=t,H(e),n=!0}else if(!i.isText()){const r=Array.from(t.childNodes).findIndex((e=>e.isEqualNode(o.target))),l=e.domParseNode(o.target);i.children.splice(r,0,l),l.parent=i,s.push(o.target),e.selection.focused()&&e.setSelectionAfter(l,"all"),n=!0}}else if("childList"==o.type){const t=Array.from(o.addedNodes).filter((t=>!D(e,t)));if(t.length>0){const i=o.target;if(i.isEqualNode(e.$el))t.forEach((t=>{const o=Array.from(i.childNodes).findIndex((e=>e.isEqualNode(t))),r=e.domParseNode(t);e.stackNodes.splice(o,0,r),s.push(t),e.selection.focused()&&e.setSelectionAfter(r,"all"),n=!0}));else{const o=e.findNode(i);t.forEach((t=>{const r=Array.from(i.childNodes).findIndex((e=>e.isEqualNode(t))),l=e.domParseNode(t);o.hasChildren()?(o.children.splice(r,0,l),l.parent=o):(o.parent.children.splice(r,0,l),l.parent=o.parent),s.push(t),e.selection.focused()&&e.setSelectionAfter(l,"all"),n=!0}))}}}}n&&(s.forEach((e=>{e.parentNode.removeChild(e)})),e.updateView())})),e.domObserver.observe(e.$el,{attributes:!1,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},U=(e,t)=>{let n=[];if(e.length&&t.length){let s=0,i=0,o=e.length-1,r=t.length-1;for(;s<=o&&i<=r;){if(t[i])if(t[r])if(e[s].key==t[i].key)n.push(...j(e[s],t[i])),s++,i++;else if(e[o].key==t[r].key)n.push(...j(e[o],t[r])),o--,r--;else if(e[s].key==t[r].key)n.push({type:"move",newNode:e[s],oldNode:t[r]},...j(e[s],t[r])),s++,r--;else if(e[o].key==t[i].key)n.push({type:"move",newNode:e[o],oldNode:t[i]},...j(e[o],t[i])),o--,i++;else{let i=t.findIndex((t=>t&&t.key===e[s].key));i>=0?(n.push({type:"move",newNode:e[s],oldNode:t[i]},...j(e[s],t[i])),t[i]=null):n.push({type:"insert",newNode:e[s],oldNode:null}),s++}else r--;else i++;if(i>r)for(;s<=o;s++)n.push({type:"insert",newNode:e[s],oldNode:null});else if(s>o)for(;i<=r;i++)t[i]&&n.push({type:"remove",oldNode:t[i],newNode:null})}}else e.length?n=e.map((e=>({type:"insert",newNode:e,oldNode:null}))):t.length&&(n=t.map((e=>({type:"remove",oldNode:e,newNode:null}))));return n},j=(e,t)=>{const n=[];return e.namespace!=t.namespace?n.push({type:"replace",newNode:e,oldNode:t}):e.isText()||e.tag==t.tag?e.hasChildren()&&!t.hasChildren()||t.hasChildren()&&!e.hasChildren()?n.push({type:"replace",newNode:e,oldNode:t}):(e.isText()&&e.textContent!=t.textContent&&n.push({type:"update",oldNode:t,newNode:e,update:"textContent"}),e.isEqualStyles(t)||n.push({type:"update",newNode:e,oldNode:t,update:"styles"}),e.isEqualMarks(t)||n.push({type:"update",newNode:e,oldNode:t,update:"marks"}),e.hasChildren()&&t.hasChildren()&&n.push(...U(e.children,t.children))):n.push({type:"replace",newNode:e,oldNode:t}),n},V=(e,t)=>{const n=t.namespace?document.createElementNS(t.namespace,t.tag):document.createElement(t.tag);return t.textContent&&(n.textContent=t.textContent),t.children&&t.children.length&&n.append(...t.children.map((t=>V(e,t)))),Object.keys(t.attrs).forEach((e=>{/(^on)|(^style$)|(^face$)/g.test(e)||n.setAttribute(e,`${t.attrs[e]}`)})),Object.keys(t.styles).forEach((e=>{n.style.setProperty(e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),`${t.styles[e]}`)})),n},z=function(e){if(this.$el)if(e){const e=document.createDocumentFragment();this.stackNodes.forEach((t=>{const n=m(this,t),s=V(this,n);e.appendChild(s)})),this.$el.innerHTML="",this.$el.appendChild(e)}else U(this.stackNodes,this.oldStackNodes).forEach((e=>{if("insert"==e.type){const t=m(this,e.newNode),n=V(this,t),s=e.newNode.parent,i=e.newNode.getPrevious(s?s.children:this.stackNodes),o=s?this.findDom(s):this.$el;if(i){const e=this.findDom(i);e.nextElementSibling?o.insertBefore(n,e.nextElementSibling):o.appendChild(n)}else o.firstElementChild?o.insertBefore(n,o.firstElementChild):o.appendChild(n)}else if("remove"==e.type)try{this.findDom(e.oldNode).remove()}catch(t){}else if("update"==e.type){const t=this.findDom(e.newNode);if("textContent"==e.update)t.textContent=e.newNode.textContent||"";else if("styles"==e.update){const{addStyles:n,removeStyles:s}=((e,t)=>{const n={},s={};return e.hasStyles()&&Object.keys(e.styles).forEach((s=>{t.hasStyles()&&t.styles.hasOwnProperty(s)&&t.styles[s]===e.styles[s]||(n[s]=e.styles[s])})),t.hasStyles()&&Object.keys(t.styles).forEach((n=>{e.hasStyles()&&e.styles.hasOwnProperty(n)||(s[n]=t.styles[n])})),{addStyles:n,removeStyles:s}})(e.newNode,e.oldNode);for(let e in s)t.style.removeProperty(e);for(let e in n)t.style.setProperty(e,`${n[e]}`)}else if("marks"==e.update){const{addMarks:n,removeMarks:s}=((e,t)=>{const n={},s={};return e.hasMarks()&&Object.keys(e.marks).forEach((s=>{t.hasMarks()&&t.marks.hasOwnProperty(s)&&t.marks[s]===e.marks[s]||(n[s]=e.marks[s])})),t.hasMarks()&&Object.keys(t.marks).forEach((n=>{e.hasMarks()&&e.marks.hasOwnProperty(n)||(s[n]=t.marks[n])})),{addMarks:n,removeMarks:s}})(e.newNode,e.oldNode);for(let e in s)t.removeAttribute(e);for(let e in n)/(^on)|(^style$)|(^face$)/g.test(e)||t.setAttribute(e,`${n[e]}`)}}else if("replace"==e.type){const t=m(this,e.newNode),n=V(this,t),s=this.findDom(e.oldNode);(e.oldNode.parent?this.findDom(e.oldNode.parent):this.$el).insertBefore(n,s),s.remove()}else if("move"==e.type){const t=this.findDom(e.newNode),n=e.newNode.parent,s=e.newNode.getPrevious(n?n.children:this.stackNodes),i=n?this.findDom(n):this.$el;if(s){const e=this.findDom(s);e.nextElementSibling?i.insertBefore(t,e.nextElementSibling):i.appendChild(t)}else i.firstElementChild?i.insertBefore(t,i.firstElementChild):i.appendChild(t)}}))};class _{constructor(){n(this,"$el"),n(this,"allowCopy",!0),n(this,"allowPaste",!0),n(this,"allowCut",!0),n(this,"allowPasteHtml",!1),n(this,"textRenderTag","span"),n(this,"blockRenderTag","p"),n(this,"voidRenderTags",["colgroup","col"]),n(this,"emptyRenderTags",["meta","link","style","script","title","base","noscript","template","annotation"]),n(this,"extraKeepTags",[]),n(this,"formatRules",[k,S,v,P,I]),n(this,"domParseNodeCallback"),n(this,"onMergeBlockNode"),n(this,"onUpdateView"),n(this,"onPasteText"),n(this,"onPasteHtml"),n(this,"onPasteImage"),n(this,"onPasteVideo"),n(this,"onPasteFile"),n(this,"onChange"),n(this,"onSelectionUpdate"),n(this,"onInsertParagraph"),n(this,"onDeleteInStart"),n(this,"onDeleteComplete"),n(this,"onKeydown"),n(this,"onKeyup"),n(this,"onFocus"),n(this,"onBlur"),n(this,"guid",function(){let e=l.get(window,"data-kaitify-guid")||0;return e++,l.set(window,"data-kaitify-guid",e),e}()),n(this,"selection",new x),n(this,"history",new E),n(this,"stackNodes",[]),n(this,"oldStackNodes",[]),n(this,"isComposition",!1),n(this,"internalCauseSelectionChange",!1),n(this,"domObserver",null)}findNode(e){if(!y(this.$el,e))throw new Error("The dom should be in the editor area, but what you provide is not");const t=e.getAttribute(p);if(!t)throw new Error(`The dom generated by editor should all have a ${p} attribute, but your dom does not. Check for "updateView" related issues`);const n=b.searchByKey(t,this.stackNodes);if(!n)throw new Error("Unexpected error occurred: the knode was not found in the editor");return n}findDom(e){let t=e.tag;e.isText()&&(t=this.textRenderTag);const n=this.$el.querySelector(`${t}[${p}="${e.key}"]`);if(!n)throw new Error("Unexpected error occurred: the dom was not found in the editor");return n}setEditable(e){var t,n;e?null==(t=this.$el)||t.setAttribute("contenteditable","true"):null==(n=this.$el)||n.removeAttribute("contenteditable")}isEditable(){var e;return"true"==(null==(e=this.$el)?void 0:e.getAttribute("contenteditable"))}checkNodes(){if(0==b.flat(this.stackNodes).filter((e=>!e.isEmpty()&&!this.voidRenderTags.includes(e.tag))).length){const e=b.create({type:"block",tag:this.blockRenderTag}),t=b.createPlaceholder();this.addNode(t,e),this.stackNodes=[e],this.selection.focused()&&this.setSelectionBefore(t)}}convertToBlock(e){if(e.isBlock())return;const t=e.clone(!0);(e.isText()||e.isClosed())&&(this.isSelectionInNode(e,"start")&&(this.selection.start.node=t),this.isSelectionInNode(e,"end")&&(this.selection.end.node=t)),e.type="block",e.tag=this.blockRenderTag,e.marks=void 0,e.styles=void 0,e.textContent=void 0,e.children=[t],t.parent=e}domParseNode(e){if(1!=e.nodeType&&3!=e.nodeType)throw new Error("The argument must be an element node or text node");if(3==e.nodeType)return b.create({type:"text",textContent:e.textContent||""});const t=(e=>{let t={};const n=e.attributes.length;for(let s=0;s<n;s++){const n=e.attributes[s];new RegExp(`(^on)|(^style$)|(^face$)|(^${p}$)`,"g").test(n.nodeName)||(t[n.nodeName]=n.nodeValue||"")}return t})(e),n=(e=>{let t={};const n=e.getAttribute("style");if(n){let e=0,s=0,i=[];for(;e<n.length;)";"==n[e]&&"base64,"!=n.substring(e+1,e+8)&&(i.push(n.substring(s,e)),s=e+1),e==n.length-1&&s<e+1&&i.push(n.substring(s,e+1)),e++;i.forEach((e=>{const n=e.indexOf(":"),s=e.substring(0,n).trim(),i=e.substring(n+1).trim();var o;t[(o=s,o.replace(/-([a-z])/g,((e,t)=>t.toUpperCase())))]=i}))}return t})(e),s=e.nodeName.toLocaleLowerCase(),i=e.namespaceURI;if(this.voidRenderTags.includes(s))return b.create({type:"text"});if(s==this.textRenderTag&&e.childNodes.length&&Array.from(e.childNodes).every((e=>3==e.nodeType)))return b.create({type:"text",marks:t,styles:n,textContent:e.textContent||""});const o=N.find((e=>e.tag==s)),r=C.find((e=>e.tag==s)),l=T.find((e=>e.tag==s)),d={type:"inline",tag:s,marks:t,styles:n,namespace:i||""};if(o)d.type="block",d.children=[],o.parse&&(d.tag=this.blockRenderTag),o.fixed&&(d.fixed=o.fixed);else if(r){if(d.type="inline",d.children=[],r.parse&&(d.tag=this.textRenderTag,a.isObject(r.parse))){const t=r.parse;for(let n in t)"function"==typeof t[n]?d.styles[n]=t[n].apply(this,[e]):d.styles[n]=t[n]}}else l?d.type="closed":this.extraKeepTags.includes(s)||(d.type="inline",d.tag=this.textRenderTag,d.namespace="",d.children=[]);let c=b.create(d);return l||Array.from(e.childNodes).forEach((e=>{if(1==e.nodeType||3==e.nodeType){const t=this.domParseNode(e);t.parent=c,c.hasChildren()?c.children.push(t):c.children=[t]}})),"function"==typeof this.domParseNodeCallback&&(c=this.domParseNodeCallback.apply(this,[c])),c}htmlParseNode(e){const t=document.createElement("template");t.innerHTML=e;const n=[];return t.content.childNodes.forEach((e=>{if(1==e.nodeType||3==e.nodeType){const t=this.domParseNode(e);n.push(t)}})),n}isRootBlock(e){return this.stackNodes.findIndex((t=>t.isEqual(e)))>-1&&e.isBlock()}getRootBlock(e){return this.stackNodes.findIndex((t=>t.isEqual(e)))>-1?e.isBlock()?e:null:e.parent?this.getRootBlock(e.parent):null}mergeBlock(e,t){if(!e.isBlock()||!t.isBlock())return;if(e.isEmpty()||t.isEmpty())return;if("function"!=typeof this.onMergeBlockNode||this.onMergeBlockNode.apply(this,[e,t])){const n=t.children.map((t=>(t.parent=e,t)));e.children.push(...n),t.children=[]}}addNode(e,t,n=0){e.isEmpty()||t.isText()||t.isClosed()||(t.hasChildren()||(t.children=[]),n>=t.children.length?t.children.push(e):t.children.splice(n,0,e),e.parent=t)}addNodeBefore(e,t){if(t.parent){const n=t.parent.children.findIndex((e=>t.isEqual(e)));this.addNode(e,t.parent,n)}else{const n=this.stackNodes.findIndex((e=>t.isEqual(e)));this.stackNodes.splice(n,0,e),e.parent=void 0}}addNodeAfter(e,t){if(t.parent){const n=t.parent.children.findIndex((e=>t.isEqual(e)));this.addNode(e,t.parent,n+1)}else{const n=this.stackNodes.findIndex((e=>t.isEqual(e)));this.stackNodes.splice(n+1,0,e),e.parent=void 0}}getLastSelectionNodeInChildren(e){if(e.isEmpty())return null;if(e.tag&&this.voidRenderTags.includes(e.tag))return null;if(e.isText()||e.isClosed())return e;let t=null;for(let n=e.children.length-1;n>=0;n--){const s=e.children[n];if(t=this.getLastSelectionNodeInChildren(s),t)break}return t}getFirstSelectionNodeInChildren(e){if(e.isEmpty())return null;if(e.tag&&this.voidRenderTags.includes(e.tag))return null;if(e.isText()||e.isClosed())return e;let t=null;const n=e.children.length;for(let s=0;s<n;s++){const n=e.children[s];if(t=this.getFirstSelectionNodeInChildren(n),t)break}return t}getPreviousSelectionNode(e){const t=e.parent?e.parent.children:this.stackNodes,n=e.getPrevious(t);return n?n.isEmpty()||n.tag&&this.voidRenderTags.includes(n.tag)?this.getPreviousSelectionNode(n):n.isText()||n.isClosed()?n:this.getLastSelectionNodeInChildren(n):e.parent?this.getPreviousSelectionNode(e.parent):null}getNextSelectionNode(e){const t=e.parent?e.parent.children:this.stackNodes,n=e.getNext(t);return n?n.isEmpty()||n.tag&&this.voidRenderTags.includes(n.tag)?this.getNextSelectionNode(n):n.isText()||n.isClosed()?n:this.getFirstSelectionNodeInChildren(n):e.parent?this.getNextSelectionNode(e.parent):null}setSelectionBefore(e,t="all"){if(e){const n=this.getFirstSelectionNodeInChildren(e);n&&("start"!=t&&"all"!=t||(this.selection.start={node:n,offset:0}),"end"!=t&&"all"!=t||(this.selection.end={node:n,offset:0}))}else{const e=this.stackNodes[0];let n=this.getFirstSelectionNodeInChildren(e);n||(n=this.getNextSelectionNode(e)),n&&("start"!=t&&"all"!=t||(this.selection.start={node:n,offset:0}),"end"!=t&&"all"!=t||(this.selection.end={node:n,offset:0}))}}setSelectionAfter(e,t="all"){if(e){const n=this.getLastSelectionNodeInChildren(e);n&&("start"!=t&&"all"!=t||(this.selection.start={node:n,offset:n.isText()?n.textContent.length:1}),"end"!=t&&"all"!=t||(this.selection.end={node:n,offset:n.isText()?n.textContent.length:1}))}else{const e=this.stackNodes[this.stackNodes.length-1];let n=this.getLastSelectionNodeInChildren(e);n||(n=this.getPreviousSelectionNode(e)),n&&("start"!=t&&"all"!=t||(this.selection.start={node:n,offset:n.isText()?n.textContent.length:1}),"end"!=t&&"all"!=t||(this.selection.end={node:n,offset:n.isText()?n.textContent.length:1}))}}updateSelectionRecently(e="all"){if(this.selection.focused()){if("start"==e||"all"==e){const e=this.getPreviousSelectionNode(this.selection.start.node),t=this.getNextSelectionNode(this.selection.start.node),n=this.selection.start.node.getBlock();e&&n.isContains(e)?(this.selection.start.node=e,this.selection.start.offset=e.isText()?e.textContent.length:1):t&&n.isContains(t)?(this.selection.start.node=t,this.selection.start.offset=0):e?(this.selection.start.node=e,this.selection.start.offset=e.isText()?e.textContent.length:1):t&&(this.selection.start.node=t,this.selection.start.offset=0)}if("end"==e||"all"==e){const e=this.getPreviousSelectionNode(this.selection.end.node),t=this.getNextSelectionNode(this.selection.end.node),n=this.selection.end.node.getBlock();e&&n.isContains(e)?(this.selection.end.node=e,this.selection.end.offset=e.isText()?e.textContent.length:1):t&&n.isContains(t)?(this.selection.end.node=t,this.selection.end.offset=0):e?(this.selection.end.node=e,this.selection.end.offset=e.isText()?e.textContent.length:1):t&&(this.selection.end.node=t,this.selection.end.offset=0)}}}isSelectionInNode(e,t="all"){return!!this.selection.focused()&&("start"==t?e.isContains(this.selection.start.node):"end"==t?e.isContains(this.selection.end.node):"all"==t?e.isContains(this.selection.start.node)&&e.isContains(this.selection.end.node):void 0)}getAllowMergeNode(e,t){if(e.isEmpty())return null;if(!e.parent)return null;if(e.locked)return null;if("prevSibling"==t){const t=e.getPrevious(e.parent.children);return t?e.isText()?t.isText()&&t.isEqualMarks(e)&&t.isEqualStyles(e)?t:null:e.isInline()&&t.isInline()&&t.tag==e.tag&&t.isEqualMarks(e)&&t.isEqualStyles(e)?t:null:null}if("nextSibling"==t){const t=e.getNext(e.parent.children);return t?e.isText()?t.isText()&&t.isEqualMarks(e)&&t.isEqualStyles(e)?t:null:e.isInline()&&t.isInline()&&t.tag==e.tag&&t.isEqualMarks(e)&&t.isEqualStyles(e)?t:null:null}return"parent"==t?e.parent.children.length>1?null:e.isText()?e.parent.isInline()&&e.parent.tag==this.textRenderTag?e.parent:null:e.type==e.parent.type&&e.tag==e.parent.tag?e.parent:null:null}applyMergeNode(e,t){const n=this.getAllowMergeNode(e,t);if(n){if("prevSibling"==t)if(e.isText()){this.isSelectionInNode(n,"start")&&(this.selection.start.node=e),this.isSelectionInNode(n,"end")&&(this.selection.end.node=e),e.textContent=n.textContent+e.textContent;const t=n.parent.children.findIndex((e=>n.isEqual(e)));n.parent.children.splice(t,1)}else if(e.isInline()){e.children=[...n.children,...e.children].map((t=>(t.parent=e,t)));const t=n.parent.children.findIndex((e=>n.isEqual(e)));if(n.parent.children.splice(t,1),e.hasChildren()&&e.children.length>1){let t=0;for(;e.hasChildren()&&t<=e.children.length-2;){this.getAllowMergeNode(e.children[t],"nextSibling")?(this.applyMergeNode(e.children[t],"nextSibling"),e.hasChildren()&&1==e.children.length&&this.applyMergeNode(e.children[0],"parent")):t++}}}if("nextSibling"==t)if(e.isText()){this.isSelectionInNode(n,"start")&&(this.selection.start.node=e,this.selection.start.offset=e.textContent.length+this.selection.start.offset),this.isSelectionInNode(n,"end")&&(this.selection.end.node=e,this.selection.end.offset=e.textContent.length+this.selection.end.offset),e.textContent+=n.textContent;const t=n.parent.children.findIndex((e=>n.isEqual(e)));n.parent.children.splice(t,1)}else if(e.isInline()){e.children=[...e.children,...n.children].map((t=>(t.parent=e,t)));const t=n.parent.children.findIndex((e=>n.isEqual(e)));if(n.parent.children.splice(t,1),e.hasChildren()&&e.children.length>1){let t=0;for(;e.hasChildren()&&t<=e.children.length-2;){this.getAllowMergeNode(e.children[t],"nextSibling")?(this.applyMergeNode(e.children[t],"nextSibling"),e.hasChildren()&&1==e.children.length&&this.applyMergeNode(e.children[0],"parent")):t++}}}"parent"==t&&(e.isText()?(n.type="text",n.tag=void 0,e.hasMarks()&&(n.hasMarks()?Object.assign(n.marks,a.clone(e.marks)):n.marks=a.clone(e.marks)),e.hasStyles()&&(n.hasStyles()?Object.assign(n.styles,a.clone(e.styles)):n.styles=a.clone(e.styles)),n.textContent=n.textContent,n.children=void 0,this.isSelectionInNode(e,"start")&&(this.selection.start.node=n),this.isSelectionInNode(e,"end")&&(this.selection.end.node=n)):(e.hasMarks()&&(n.hasMarks()?Object.assign(n.marks,a.clone(e.marks)):n.marks=a.clone(e.marks)),e.hasStyles()&&(n.hasStyles()?Object.assign(n.styles,a.clone(e.styles)):n.styles=a.clone(e.styles)),e.hasChildren()&&(n.children=[...e.children],n.children.forEach((e=>{e.parent=n}))),n.hasChildren()&&1==n.children.length&&this.getAllowMergeNode(n.children[0],"parent")&&(this.applyMergeNode(n.children[0],"parent"),this.getAllowMergeNode(n,"prevSibling")?this.applyMergeNode(n,"prevSibling"):this.getAllowMergeNode(n,"nextSibling")&&this.applyMergeNode(n,"nextSibling"))))}}formatNode(e,t,n){const s=n.findIndex((t=>t.isEqual(e)));if(!(s<0)){if(e.isEmpty())return this.isSelectionInNode(e,"start")&&this.updateSelectionRecently("start"),this.isSelectionInNode(e,"end")&&this.updateSelectionRecently("end"),void n.splice(s,1);if(t({editor:this,node:e}),e.isEmpty()){this.isSelectionInNode(e,"start")&&this.updateSelectionRecently("start"),this.isSelectionInNode(e,"end")&&this.updateSelectionRecently("end");const t=n.findIndex((t=>t.isEqual(e)));n.splice(t,1)}else if(e.isBlock()||n!==this.stackNodes||this.convertToBlock(e),e.hasChildren()&&e.children.forEach((n=>{this.formatNode(n,t,e.children)})),e.isEmpty()){this.isSelectionInNode(e,"start")&&this.updateSelectionRecently("start"),this.isSelectionInNode(e,"end")&&this.updateSelectionRecently("end");const t=n.findIndex((t=>t.isEqual(e)));n.splice(t,1)}}}getSelectedNodes(){if(!this.selection.focused()||this.selection.collapsed())return[];const e=this.selection.start.node,t=this.selection.end.node,n=this.selection.start.offset,s=this.selection.end.offset;if(e.isEqual(t))return e.isClosed()?[{node:e,offset:!1}]:[{node:e,offset:(0!=n||s!=e.textContent.length)&&[n,s]}];const i=[];let o=e;for(;;){if(o.isEqual(e))0==n?i.push({node:o,offset:!1}):o.isText()&&n<o.textContent.length&&i.push({node:o,offset:[n,o.textContent.length]});else{if(o.isEqual(t)){s==(o.isText()?o.textContent.length:1)?i.push({node:o,offset:!1}):o.isText()&&s>0&&i.push({node:o,offset:[0,s]});break}if(o.isContains(t)){const e=this.getLastSelectionNodeInChildren(o);if(t.isEqual(e)&&s==(t.isText()?t.textContent.length:1)){i.push({node:o,offset:!1});break}o=o.children[0];continue}i.push({node:o,offset:!1})}let r=o,l=null;for(;l=r.getNext(r.parent?r.parent.children:this.stackNodes),!l&&r.parent;)r=r.parent;if(!l)break;o=l}return i}emptyFixedBlock(e){e.isBlock()&&e.hasChildren()&&e.children.forEach((e=>{if(e.isBlock()&&e.fixed)this.emptyFixedBlock(e);else if(e.toEmpty(),e.parent.isEmpty()){const t=b.createPlaceholder();this.addNode(t,e.parent)}}))}insertText(e){if(e&&this.selection.focused())if(e=e.replace(/\r\n/g,"\n"),this.selection.collapsed()){const t=this.selection.start.node,n=this.selection.start.offset;if(t.isInCodeBlockStyle()||(e=e.replace(/\s/g,(()=>{const e=document.createElement("span");return e.innerHTML="&nbsp;",e.innerText}))),t.isText())t.textContent=t.textContent.substring(0,n)+e+t.textContent.substring(n),this.selection.start.offset=this.selection.end.offset=this.selection.start.offset+e.length;else{const s=b.create({type:"text",textContent:e});0==n?this.addNodeBefore(s,t):this.addNodeAfter(s,t),this.setSelectionAfter(s)}}else this.delete(),this.insertText(e)}insertParagraph(){if(this.selection.focused())if(this.selection.collapsed()){const e=this.selection.start.node,t=this.selection.start.offset,n=e.getBlock(),s=this.getFirstSelectionNodeInChildren(n),i=this.getLastSelectionNodeInChildren(n);if(e.isInCodeBlockStyle()){this.insertText("\n");const e=b.createZeroWidthText();this.insertNode(e),this.setSelectionAfter(e,"all"),"function"==typeof this.onInsertParagraph&&this.onInsertParagraph.apply(this,[n,n])}else if(!n.fixed)if(s.isEqual(e)&&0==t){const e=n.clone(!1),t=b.createPlaceholder();this.addNode(t,e),this.addNodeBefore(e,n),"function"==typeof this.onInsertParagraph&&this.onInsertParagraph.apply(this,[n,e])}else if(i.isEqual(e)&&t==(e.isText()?e.textContent.length:1)){const e=n.clone(!1),t=b.createPlaceholder();this.addNode(t,e),this.addNodeAfter(e,n),this.setSelectionBefore(t),"function"==typeof this.onInsertParagraph&&this.onInsertParagraph.apply(this,[e,n])}else{const e=n.clone(!0);this.addNodeAfter(e,n);const t=b.flat(n.children).findIndex((e=>this.selection.start.node.isEqual(e))),s=this.selection.start.offset;this.setSelectionAfter(i,"end"),this.delete(),this.setSelectionBefore(e,"start"),this.selection.end.node=b.flat(e.children)[t],this.selection.end.offset=s,this.delete(),"function"==typeof this.onInsertParagraph&&this.onInsertParagraph.apply(this,[e,n])}}else this.delete(),this.insertParagraph()}insertNode(e,t=!1){if(this.selection.focused()&&!e.isEmpty())if(this.selection.collapsed()){const n=this.selection.start.node,s=this.selection.start.offset,i=n.getBlock(),o=this.getFirstSelectionNodeInChildren(i),r=this.getLastSelectionNodeInChildren(i);if(i.fixed||!e.isBlock()||e.fixed)if(0==s)this.addNodeBefore(e,n);else if(s==(n.isText()?n.textContent.length:1))this.addNodeAfter(e,n);else{const t=n.textContent,i=n.clone();n.textContent=t.substring(0,s),i.textContent=t.substring(s),this.addNodeAfter(i,n),this.addNodeBefore(e,i)}else if(i.allIsPlaceholder()&&t)this.addNodeBefore(e,i),i.toEmpty();else if(o.isEqual(n)&&0==s)this.addNodeBefore(e,i);else if(r.isEqual(n)&&s==(n.isText()?n.textContent.length:1))this.addNodeAfter(e,i);else{this.insertParagraph();const t=this.selection.start.node.getBlock();this.addNodeBefore(e,t)}this.setSelectionAfter(e,"all")}else this.delete(),this.insertNode(e,t)}delete(){if(this.selection.focused()){if(this.selection.collapsed()){const e=this.selection.start.node,t=this.selection.start.offset,n=this.getPreviousSelectionNode(e),s=e.getBlock();if(0==t)if(n){const e=n.getBlock();if(e.isEqual(s))return this.setSelectionAfter(n,"all"),void this.delete();s.fixed||this.mergeBlock(e,s)}else"function"==typeof this.onDeleteInStart&&this.onDeleteInStart.apply(this,[s]);else{if(e.isZeroWidthText()){if(e.toEmpty(),s.isEmpty()){const e=b.createPlaceholder();this.addNode(e,s),this.setSelectionBefore(e)}else this.setSelectionAfter(n,"all");return void this.delete()}if(e.isText()){const n=e.textContent.substring(t-1,t);if(e.textContent=e.textContent.substring(0,t-1)+e.textContent.substring(t),this.selection.start.offset=t-1,this.selection.end.offset=t-1,g(n))return void this.delete();if(s.isEmpty()){const e=b.createPlaceholder();this.addNode(e,s),this.setSelectionBefore(e)}}else if(e.isClosed()){const t=e.isPlaceholder();if(e.toEmpty(),s.isEmpty())if(t){if(s.fixed){const e=b.createPlaceholder();this.addNode(e,s),this.setSelectionBefore(e)}else if(!s.fixed&&!n){const e=b.createPlaceholder();this.addNode(e,s),this.setSelectionBefore(e),"function"==typeof this.onDeleteInStart&&this.onDeleteInStart.apply(this,[s])}}else{const e=b.createPlaceholder();this.addNode(e,s),this.setSelectionBefore(e)}}}}else{const e=this.getSelectedNodes().filter((e=>!this.voidRenderTags.includes(e.node.tag))),t=this.selection.start.node.getBlock(),n=this.selection.end.node.getBlock();if(e.forEach((e=>{const{node:t,offset:n}=e;n?t.textContent=t.textContent.substring(0,n[0])+t.textContent.substring(n[1]):t.isBlock()&&t.fixed?this.emptyFixedBlock(t):t.toEmpty()})),t.isEqual(n)){if(t.isEmpty()){const e=b.createPlaceholder();this.addNode(e,t),this.setSelectionBefore(e)}}else{if(t.isEmpty()){const e=b.createPlaceholder();this.addNode(e,t),this.setSelectionBefore(e,"start")}if(n.isEmpty()){const e=b.createPlaceholder();this.addNode(e,n),this.setSelectionBefore(e,"end")}n.fixed||this.mergeBlock(t,n)}}this.selection.start.node.isEmpty()&&this.updateSelectionRecently("start"),this.selection.end.node=this.selection.start.node,this.selection.end.offset=this.selection.start.offset,"function"==typeof this.onDeleteComplete&&this.onDeleteComplete.apply(this)}}async updateView(e=!1){if(!this.$el)return;B(this.stackNodes,this.oldStackNodes).forEach((e=>{let t=null;if(e.newNode)t=e.newNode.parent?e.newNode.parent:e.newNode;else if(e.oldNode&&e.oldNode.parent){const n=b.searchByKey(e.oldNode.parent.key,this.stackNodes);t=n||null}t&&this.formatRules.forEach((e=>{this.formatNode(t,e,t.parent?t.parent.children:this.stackNodes)}))})),this.checkNodes();const t=this.$el.innerHTML;("function"!=typeof this.onUpdateView||await this.onUpdateView.apply(this,[!1]))&&z.apply(this,[!1]);const n=this.$el.innerHTML;t!=n&&("function"==typeof this.onChange&&this.onChange.apply(this,[n,t]),e||this.history.setState(this.stackNodes,this.selection)),this.oldStackNodes=this.stackNodes.map((e=>e.fullClone())),await this.updateRealSelection()}async updateRealSelection(){const e=window.getSelection();if(e){if(this.selection.focused()){this.internalCauseSelectionChange=!0;const t=document.createRange(),n=this.findDom(this.selection.start.node),s=this.findDom(this.selection.end.node);if(this.selection.start.node.isText())t.setStart(n.childNodes[0],this.selection.start.offset);else if(this.selection.start.node.isClosed()){const e=this.selection.start.node.parent.children.findIndex((e=>this.selection.start.node.isEqual(e)));t.setStart(n.parentNode,this.selection.start.offset+e)}if(this.selection.end.node.isText())t.setEnd(s.childNodes[0],this.selection.end.offset);else if(this.selection.end.node.isClosed()){const e=this.selection.end.node.parent.children.findIndex((e=>this.selection.end.node.isEqual(e)));t.setEnd(s.parentNode,this.selection.end.offset+e)}e.removeAllRanges(),e.addRange(t)}else e.removeAllRanges();await w(),this.internalCauseSelectionChange=!1,this.scrollViewToSelection(),this.history.updateSelection(this.selection),"function"==typeof this.onSelectionUpdate&&this.onSelectionUpdate.apply(this,[this.selection])}}updateSelection(){if(!this.$el)return!1;const e=window.getSelection();if(e&&e.rangeCount){const t=e.getRangeAt(0);if(y(this.$el,t.startContainer)&&y(this.$el,t.endContainer)){if(3==t.startContainer.nodeType)this.selection.start={node:this.findNode(t.startContainer.parentNode),offset:t.startOffset};else if(1==t.startContainer.nodeType){const e=Array.from(t.startContainer.childNodes);if(e.length){const n=e[t.startOffset]?e[t.startOffset]:e[t.startOffset-1];1==n.nodeType?e[t.startOffset]?this.setSelectionBefore(this.findNode(n),"start"):this.setSelectionAfter(this.findNode(n),"start"):3==n.nodeType&&(this.selection.start={node:this.findNode(n.parentNode),offset:e[t.startOffset]?0:n.textContent.length})}else this.selection.start={node:this.findNode(t.startContainer),offset:0}}if(3==t.endContainer.nodeType)this.selection.end={node:this.findNode(t.endContainer.parentNode),offset:t.endOffset};else if(1==t.endContainer.nodeType){const e=Array.from(t.endContainer.childNodes);if(e.length){const n=e[t.endOffset]?e[t.endOffset]:e[t.endOffset-1];1==n.nodeType?e[t.endOffset]?this.setSelectionBefore(this.findNode(n),"end"):this.setSelectionAfter(this.findNode(n),"end"):3==n.nodeType&&(this.selection.end={node:this.findNode(n.parentNode),offset:e[t.endOffset]?0:n.textContent.length})}else this.selection.end={node:this.findNode(t.endContainer),offset:1}}return!0}}return!1}scrollViewToSelection(){if(this.selection.focused()){const e=this.findDom(this.selection.end.node),t=async t=>{const n=o.getScrollHeight(t),s=o.getScrollWidth(t);if(t.clientHeight<n||t.clientWidth<s){const i=window.getSelection().getRangeAt(0),r=i.getClientRects();let l=i;0==r.length&&(l=e);const a=l.getBoundingClientRect(),d=t.getBoundingClientRect();if(t.clientHeight<n)if(a.top<d.top){await o.setScrollTop({el:t,number:0});const e=l.getBoundingClientRect(),n=t.getBoundingClientRect();o.setScrollTop({el:t,number:e.top-n.top})}else if(a.bottom>d.bottom){await o.setScrollTop({el:t,number:0});const e=l.getBoundingClientRect(),n=t.getBoundingClientRect();o.setScrollTop({el:t,number:e.bottom-n.bottom})}if(t.clientWidth<s)if(a.left<d.left){await o.setScrollLeft({el:t,number:0});const e=l.getBoundingClientRect(),n=t.getBoundingClientRect();o.setScrollLeft({el:t,number:e.left-n.left+20})}else if(a.right>d.right){await o.setScrollLeft({el:t,number:0});const e=l.getBoundingClientRect(),n=t.getBoundingClientRect();o.setScrollLeft({el:t,number:e.right-n.right+20})}}};let n=e;for(;o.isElement(n)&&n!=document.documentElement;)t(n),n=n.parentNode}}undo(){const e=this.history.setUndo();e&&(this.stackNodes=e.nodes,this.selection=e.selection,this.updateView(!0))}redo(){const e=this.history.setRedo();e&&(this.stackNodes=e.nodes,this.selection=e.selection,this.updateView(!0))}destroy(){this.setEditable(!1),h.off(document,`selectionchange.kaitify_${this.guid}`),h.off(this.$el,"beforeinput.kaitify compositionstart.kaitify compositionupdate.kaitify compositionend.kaitify keydown.kaitify keyup.kaitify copy.kaitify focus.kaitify blur.kaitify")}static async configure(e){const t=new _;t.$el=(e=>{if("string"==typeof e&&e&&(e=document.body.querySelector(e)),!o.isElement(e))throw new Error("You must specify a dom container to initialize the editor");if(l.get(e,"data-kaitify-init"))throw new Error("The element node has been initialized to the editor");return l.set(e,"data-kaitify-init",!0),e})(e.el),"boolean"==typeof e.allowCopy&&(t.allowCopy=e.allowCopy),"boolean"==typeof e.allowCut&&(t.allowCut=e.allowCut),"boolean"==typeof e.allowPaste&&(t.allowPaste=e.allowPaste),"boolean"==typeof e.allowPasteHtml&&(t.allowPasteHtml=e.allowPasteHtml),e.textRenderTag&&(t.textRenderTag=e.textRenderTag),e.blockRenderTag&&(t.blockRenderTag=e.blockRenderTag),e.voidRenderTags&&(t.voidRenderTags=e.voidRenderTags),e.emptyRenderTags&&(t.emptyRenderTags=e.emptyRenderTags),e.extraKeepTags&&(t.extraKeepTags=e.extraKeepTags),e.formatRules&&(t.formatRules=[...t.formatRules,...e.formatRules]),e.domParseNodeCallback&&(t.domParseNodeCallback=e.domParseNodeCallback),e.onMergeBlockNode&&(t.onMergeBlockNode=e.onMergeBlockNode),e.onUpdateView&&(t.onUpdateView=e.onUpdateView),e.onPasteText&&(t.onPasteText=e.onPasteText),e.onPasteHtml&&(t.onPasteHtml=e.onPasteHtml),e.onPasteImage&&(t.onPasteImage=e.onPasteImage),e.onPasteVideo&&(t.onPasteVideo=e.onPasteVideo),e.onPasteFile&&(t.onPasteFile=e.onPasteFile),e.onChange&&(t.onChange=e.onChange),e.onSelectionUpdate&&(t.onSelectionUpdate=e.onSelectionUpdate),e.onInsertParagraph&&(t.onInsertParagraph=e.onInsertParagraph),e.onDeleteInStart&&(t.onDeleteInStart=e.onDeleteInStart),e.onDeleteComplete&&(t.onDeleteComplete=e.onDeleteComplete),e.onKeydown&&(t.onKeydown=e.onKeydown),e.onKeyup&&(t.onKeyup=e.onKeyup),e.onFocus&&(t.onFocus=e.onFocus),e.onBlur&&(t.onBlur=e.onBlur),t.setEditable("boolean"!=typeof e.editable||e.editable),t.stackNodes=t.htmlParseNode(e.value||""),t.stackNodes.forEach((e=>{t.formatRules.forEach((n=>{t.formatNode(e,n,t.stackNodes)}))})),t.checkNodes();return("function"!=typeof t.onUpdateView||await t.onUpdateView.apply(t,[!0]))&&z.apply(t,[!0]),t.history.setState(t.stackNodes,t.selection),t.oldStackNodes=t.stackNodes.map((e=>e.fullClone())),e.autofocus&&(t.setSelectionAfter(),await t.updateRealSelection()),H(t),h.on(document,`selectionchange.kaitify_${t.guid}`,R.bind(t)),h.on(t.$el,"beforeinput.kaitify",L.bind(t)),h.on(t.$el,"compositionstart.kaitify compositionupdate.kaitify compositionend.kaitify",q.bind(t)),h.on(t.$el,"keydown.kaitify keyup.kaitify",$.bind(t)),h.on(t.$el,"focus.kaitify",O.bind(t)),h.on(t.$el,"blur.kaitify",F.bind(t)),h.on(t.$el,"copy.kaitify",W.bind(t)),e.onCreated&&e.onCreated.apply(t),t}}e.Editor=_,e.History=E,e.KNode=b,e.NODE_MARK=p,e.Selection=x,e.getNodeRenderOptions=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
